(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=e(a);fetch(a.href,r)}})();var U={ability:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},activation:{type:"text"},duration:{type:"number"},potency:{type:"number"},range:{type:"number"},effects:{type:"multi_link",target:"phenomenon"},challenges:{type:"text"},talents:{type:"multi_link",target:"trait"},requisites:{type:"multi_link",target:"construct"},prevalence:{type:"text"},tradition:{type:"single_link",target:"construct"},source:{type:"single_link",target:"phenomenon"},locus:{type:"single_link",target:"location"},instruments:{type:"multi_link",target:"object"},systems:{type:"multi_link",target:"construct"}},character:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},physicality:{type:"text"},mentality:{type:"text"},height:{type:"number"},weight:{type:"number"},species:{type:"multi_link",target:"species"},traits:{type:"multi_link",target:"trait"},abilities:{type:"multi_link",target:"ability"},background:{type:"text"},motivations:{type:"text"},birth_date:{type:"number"},birthplace:{type:"single_link",target:"location"},languages:{type:"multi_link",target:"language"},reputation:{type:"text"},location:{type:"single_link",target:"location"},objects:{type:"multi_link",target:"object"},institutions:{type:"multi_link",target:"institution"},charisma:{type:"number"},coercion:{type:"number"},competence:{type:"number"},compassion:{type:"number"},creativity:{type:"number"},courage:{type:"number"},family:{type:"multi_link",target:"family"},friends:{type:"multi_link",target:"character"},rivals:{type:"multi_link",target:"character"},level:{type:"number"},hit_points:{type:"number"},STR:{type:"number"},DEX:{type:"number"},CON:{type:"number"},INT:{type:"number"},WIS:{type:"number"},CHA:{type:"number"}},collective:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},composition:{type:"text"},count:{type:"number"},formation_date:{type:"number"},operator:{type:"single_link",target:"institution"},equipment:{type:"multi_link",target:"construct"},activity:{type:"text"},disposition:{type:"text"},state:{type:"text"},abilities:{type:"multi_link",target:"ability"},symbolism:{type:"multi_link",target:"construct"},species:{type:"multi_link",target:"species"},characters:{type:"multi_link",target:"character"},creatures:{type:"multi_link",target:"creature"},phenomena:{type:"multi_link",target:"phenomenon"}},construct:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},rationale:{type:"text"},history:{type:"text"},status:{type:"text"},reach:{type:"text"},start_date:{type:"number"},end_date:{type:"number"},founder:{type:"single_link",target:"character"},custodian:{type:"single_link",target:"institution"},characters:{type:"multi_link",target:"character"},objects:{type:"multi_link",target:"object"},locations:{type:"multi_link",target:"location"},species:{type:"multi_link",target:"species"},creatures:{type:"multi_link",target:"creature"},institutions:{type:"multi_link",target:"institution"},traits:{type:"multi_link",target:"trait"},collectives:{type:"multi_link",target:"collective"},zones:{type:"multi_link",target:"zone"},abilities:{type:"multi_link",target:"ability"},phenomena:{type:"multi_link",target:"phenomenon"},languages:{type:"multi_link",target:"language"},families:{type:"multi_link",target:"family"},relations:{type:"multi_link",target:"relation"},titles:{type:"multi_link",target:"title"},constructs:{type:"multi_link",target:"construct"},events:{type:"multi_link",target:"event"},narratives:{type:"multi_link",target:"narrative"}},creature:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},appearance:{type:"text"},weight:{type:"number"},height:{type:"number"},species:{type:"multi_link",target:"species"},habits:{type:"text"},demeanor:{type:"text"},traits:{type:"multi_link",target:"trait"},abilities:{type:"multi_link",target:"ability"},languages:{type:"multi_link",target:"language"},status:{type:"text"},birth_date:{type:"number"},location:{type:"single_link",target:"location"},zone:{type:"single_link",target:"zone"},challenge_rating:{type:"number"},hit_points:{type:"number"},armor_class:{type:"number"},speed:{type:"number"},actions:{type:"multi_link",target:"ability"}},event:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},history:{type:"text"},challenges:{type:"text"},consequences:{type:"text"},start_date:{type:"number"},end_date:{type:"number"},triggers:{type:"multi_link",target:"event"},characters:{type:"multi_link",target:"character"},objects:{type:"multi_link",target:"object"},locations:{type:"multi_link",target:"location"},species:{type:"multi_link",target:"species"},creatures:{type:"multi_link",target:"creature"},institutions:{type:"multi_link",target:"institution"},traits:{type:"multi_link",target:"trait"},collectives:{type:"multi_link",target:"collective"},zones:{type:"multi_link",target:"zone"},abilities:{type:"multi_link",target:"ability"},phenomena:{type:"multi_link",target:"phenomenon"},languages:{type:"multi_link",target:"language"},families:{type:"multi_link",target:"family"},relations:{type:"multi_link",target:"relation"},titles:{type:"multi_link",target:"title"},constructs:{type:"multi_link",target:"construct"}},family:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},spirit:{type:"text"},history:{type:"text"},traditions:{type:"multi_link",target:"construct"},traits:{type:"multi_link",target:"trait"},abilities:{type:"multi_link",target:"ability"},languages:{type:"multi_link",target:"language"},ancestors:{type:"multi_link",target:"character"},reputation:{type:"text"},estates:{type:"multi_link",target:"location"},governs:{type:"multi_link",target:"institution"},heirlooms:{type:"multi_link",target:"object"},creatures:{type:"multi_link",target:"creature"}},institution:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},doctrine:{type:"text"},founding_date:{type:"number"},parent_institution:{type:"single_link",target:"institution"},zones:{type:"multi_link",target:"zone"},objects:{type:"multi_link",target:"object"},creatures:{type:"multi_link",target:"creature"},status:{type:"text"},allies:{type:"multi_link",target:"institution"},adversaries:{type:"multi_link",target:"institution"},constructs:{type:"multi_link",target:"construct"}},language:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},phonology:{type:"text"},grammar:{type:"text"},lexicon:{type:"text"},writing:{type:"text"},classification:{type:"single_link",target:"construct"},status:{type:"text"},spread:{type:"multi_link",target:"location"},dialects:{type:"multi_link",target:"language"}},law:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},declaration:{type:"text"},purpose:{type:"text"},date:{type:"number"},parent_law:{type:"single_link",target:"law"},penalties:{type:"multi_link",target:"construct"},author:{type:"single_link",target:"institution"},locations:{type:"multi_link",target:"location"},zones:{type:"multi_link",target:"zone"},prohibitions:{type:"multi_link",target:"construct"},adjudicators:{type:"multi_link",target:"title"},enforcers:{type:"multi_link",target:"title"}},location:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},form:{type:"text"},function:{type:"text"},founding_date:{type:"number"},parent_location:{type:"single_link",target:"location"},populations:{type:"multi_link",target:"collective"},political_climate:{type:"text"},primary_power:{type:"single_link",target:"institution"},governing_title:{type:"single_link",target:"title"},secondary_powers:{type:"multi_link",target:"institution"},zone:{type:"single_link",target:"zone"},rival:{type:"single_link",target:"location"},partner:{type:"single_link",target:"location"},customs:{type:"text"},founders:{type:"multi_link",target:"character"},cults:{type:"multi_link",target:"construct"},delicacies:{type:"multi_link",target:"species"},extraction_methods:{type:"multi_link",target:"construct"},extraction_goods:{type:"multi_link",target:"construct"},industry_methods:{type:"multi_link",target:"construct"},industry_goods:{type:"multi_link",target:"construct"},infrastructure:{type:"text"},extraction_markets:{type:"multi_link",target:"location"},industry_markets:{type:"multi_link",target:"location"},currencies:{type:"multi_link",target:"construct"},architecture:{type:"text"},buildings:{type:"multi_link",target:"object"},building_methods:{type:"multi_link",target:"construct"},defensibility:{type:"text"},elevation:{type:"number"},fighters:{type:"multi_link",target:"construct"},defensive_objects:{type:"multi_link",target:"object"}},map:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},background_color:{type:"text"},hierarchy:{type:"number"},width:{type:"number"},height:{type:"number"},depth:{type:"number"},parent_map:{type:"single_link",target:"map"},location:{type:"single_link",target:"location"}},marker:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},map:{type:"single_link",target:"map"},zone:{type:"single_link",target:"zone"},x:{type:"number"},y:{type:"number"},z:{type:"number"},order:{type:"number"}},narrative:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},story:{type:"text"},consequences:{type:"text"},start_date:{type:"number"},end_date:{type:"number"},order:{type:"number"},parent_narrative:{type:"single_link",target:"narrative"},protagonist:{type:"single_link",target:"character"},antagonist:{type:"single_link",target:"character"},narrator:{type:"single_link",target:"character"},conservator:{type:"single_link",target:"institution"},events:{type:"multi_link",target:"event"},characters:{type:"multi_link",target:"character"},objects:{type:"multi_link",target:"object"},locations:{type:"multi_link",target:"location"},species:{type:"multi_link",target:"species"},creatures:{type:"multi_link",target:"creature"},institutions:{type:"multi_link",target:"institution"},traits:{type:"multi_link",target:"trait"},collectives:{type:"multi_link",target:"collective"},zones:{type:"multi_link",target:"zone"},abilities:{type:"multi_link",target:"ability"},phenomena:{type:"multi_link",target:"phenomenon"},languages:{type:"multi_link",target:"language"},families:{type:"multi_link",target:"family"},relations:{type:"multi_link",target:"relation"},titles:{type:"multi_link",target:"title"},constructs:{type:"multi_link",target:"construct"},laws:{type:"multi_link",target:"law"}},object:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},aesthetics:{type:"text"},weight:{type:"number"},amount:{type:"number"},parent_object:{type:"single_link",target:"object"},materials:{type:"multi_link",target:"construct"},technology:{type:"multi_link",target:"construct"},utility:{type:"text"},effects:{type:"multi_link",target:"phenomenon"},abilities:{type:"multi_link",target:"ability"},consumes:{type:"multi_link",target:"construct"},origins:{type:"text"},location:{type:"single_link",target:"location"},language:{type:"single_link",target:"language"},affinities:{type:"multi_link",target:"trait"}},phenomenon:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},expression:{type:"text"},effects:{type:"text"},duration:{type:"number"},catalysts:{type:"multi_link",target:"object"},empowerments:{type:"multi_link",target:"ability"},mythology:{type:"text"},system:{type:"single_link",target:"phenomenon"},triggers:{type:"multi_link",target:"construct"},wielders:{type:"multi_link",target:"character"},environments:{type:"multi_link",target:"location"}},pin:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},map:{type:"single_link",target:"map"},element_type:{type:"text"},element_id:{type:"single_link",target:"any"},x:{type:"number"},y:{type:"number"},z:{type:"number"}},relation:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},background:{type:"text"},start_date:{type:"number"},end_date:{type:"number"},intensity:{type:"number"},actor:{type:"single_link",target:"character"},events:{type:"multi_link",target:"event"},characters:{type:"multi_link",target:"character"},objects:{type:"multi_link",target:"object"},locations:{type:"multi_link",target:"location"},species:{type:"multi_link",target:"species"},creatures:{type:"multi_link",target:"creature"},institutions:{type:"multi_link",target:"institution"},traits:{type:"multi_link",target:"trait"},collectives:{type:"multi_link",target:"collective"},zones:{type:"multi_link",target:"zone"},abilities:{type:"multi_link",target:"ability"},phenomena:{type:"multi_link",target:"phenomenon"},languages:{type:"multi_link",target:"language"},families:{type:"multi_link",target:"family"},relations:{type:"multi_link",target:"relation"},titles:{type:"multi_link",target:"title"},constructs:{type:"multi_link",target:"construct"},narratives:{type:"multi_link",target:"narrative"}},species:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},appearance:{type:"text"},life_span:{type:"number"},weight:{type:"number"},nourishment:{type:"multi_link",target:"species"},reproduction:{type:"multi_link",target:"construct"},adaptations:{type:"multi_link",target:"ability"},instincts:{type:"text"},sociality:{type:"text"},temperament:{type:"text"},communication:{type:"text"},aggression:{type:"number"},traits:{type:"multi_link",target:"trait"},role:{type:"text"},parent_species:{type:"single_link",target:"species"},locations:{type:"multi_link",target:"location"},zones:{type:"multi_link",target:"zone"},affinities:{type:"multi_link",target:"phenomenon"}},title:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},authority:{type:"text"},eligibility:{type:"text"},grant_date:{type:"number"},revoke_date:{type:"number"},issuer:{type:"single_link",target:"institution"},body:{type:"single_link",target:"institution"},superior_title:{type:"single_link",target:"title"},holders:{type:"multi_link",target:"character"},symbols:{type:"multi_link",target:"object"},status:{type:"text"},history:{type:"text"},characters:{type:"multi_link",target:"character"},institutions:{type:"multi_link",target:"institution"},families:{type:"multi_link",target:"family"},zones:{type:"multi_link",target:"zone"},locations:{type:"multi_link",target:"location"},objects:{type:"multi_link",target:"object"},constructs:{type:"multi_link",target:"construct"},laws:{type:"multi_link",target:"law"},collectives:{type:"multi_link",target:"collective"},creatures:{type:"multi_link",target:"creature"},phenomena:{type:"multi_link",target:"phenomenon"},species:{type:"multi_link",target:"species"},languages:{type:"multi_link",target:"language"}},trait:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},social_effects:{type:"text"},physical_effects:{type:"text"},functional_effects:{type:"text"},personality_effects:{type:"text"},behaviour_effects:{type:"text"},charisma:{type:"number"},coercion:{type:"number"},competence:{type:"number"},compassion:{type:"number"},creativity:{type:"number"},courage:{type:"number"},significance:{type:"text"},anti_trait:{type:"single_link",target:"trait"},empowered_abilities:{type:"multi_link",target:"ability"}},zone:{name:{type:"text",required:!0},description:{type:"text",required:!1},supertype:{type:"text",required:!1},subtype:{type:"text",required:!1},image_url:{type:"text",required:!1},role:{type:"text"},start_date:{type:"number"},end_date:{type:"number"},phenomena:{type:"multi_link",target:"phenomenon"},linked_zones:{type:"multi_link",target:"zone"},context:{type:"text"},populations:{type:"multi_link",target:"collective"},titles:{type:"multi_link",target:"title"},principles:{type:"multi_link",target:"construct"}}},J=class{constructor(i){this.client=i}async getStatus(){return this.client.request("GET","/tokens/status/")}async consume(i){return this.client.request("POST","/tokens/consume/",{body:{amount:i.amount,service:i.service||"sdk_client",session_id:i.sessionId??null,metadata:i.metadata??null}})}async getAccessKey(){return this.client.request("GET","/tokens/access-key/")}async revokeSession(i){return this.client.request("POST",`/tokens/revoke-session/?session_id=${encodeURIComponent(i)}`)}async revokeAllSessions(){return this.client.request("POST","/tokens/revoke-all-sessions/")}async getEncryptionInfo(){return this.client.request("GET","/tokens/encryption-info/")}},c=class{constructor(i,t){this.client=i,this.elementType=t}async list(i){const t=await this.client.request("GET",`/${this.elementType}/`,{params:i});return Array.isArray(t)?{count:t.length,next:null,previous:null,results:t}:t}async get(i){return this.client.request("GET",`/${this.elementType}/${i}/`)}async create(i){let t=$.prepareRelations(i,this.elementType);return this.elementType==="pin"&&(t=this.roundPinCoordinates(t)),this.client.request("POST",`/${this.elementType}/`,{body:t})}async update(i,t){let e=$.prepareRelations(t,this.elementType);return this.elementType==="pin"&&(e=this.roundPinCoordinates(e)),this.client.request("PATCH",`/${this.elementType}/${i}/`,{body:e})}async delete(i){return this.client.request("DELETE",`/${this.elementType}/${i}/`)}roundPinCoordinates(i){const t={...i};return typeof t.x=="number"&&(t.x=Math.round(t.x)),typeof t.y=="number"&&(t.y=Math.round(t.y)),typeof t.z=="number"&&(t.z=Math.round(t.z)),t}},X=class{constructor(i){this.client=i}async get(){return this.client.request("GET","/world/")}async update(i){return this.client.request("PATCH","/world/",{body:i})}},$=class{constructor(i){this.baseUrl=i.baseUrl||"https://www.onlyworlds.com/api/worldapi",this.headers={"Content-Type":"application/json","API-Key":i.apiKey,"API-Pin":i.apiPin},this.worlds=new X(this),this.tokens=new J(this),this.abilities=new c(this,"ability"),this.characters=new c(this,"character"),this.collectives=new c(this,"collective"),this.constructs=new c(this,"construct"),this.creatures=new c(this,"creature"),this.events=new c(this,"event"),this.families=new c(this,"family"),this.institutions=new c(this,"institution"),this.languages=new c(this,"language"),this.laws=new c(this,"law"),this.locations=new c(this,"location"),this.maps=new c(this,"map"),this.markers=new c(this,"marker"),this.narratives=new c(this,"narrative"),this.objects=new c(this,"object"),this.phenomena=new c(this,"phenomenon"),this.pins=new c(this,"pin"),this.relations=new c(this,"relation"),this.species=new c(this,"species"),this.titles=new c(this,"title"),this.traits=new c(this,"trait"),this.zones=new c(this,"zone")}async request(i,t,e){const n=new URL(`${this.baseUrl}${t}`);e?.params&&Object.entries(e.params).forEach(([s,l])=>{l!=null&&n.searchParams.append(s,String(l))});const a={method:i,headers:this.headers};e?.body&&["POST","PATCH","PUT"].includes(i)&&(a.body=JSON.stringify(e.body));const r=await fetch(n.toString(),a);if(!r.ok){let s=`API Error ${r.status}`;try{const l=await r.text();if(l)try{const o=JSON.parse(l);if(Array.isArray(o.detail)){const u=o.detail.map(p=>`${p.loc?p.loc.join("."):"unknown"}: ${p.msg}`).join("; ");s+=`: ${u}`}else s+=`: ${o.detail||o.error||l}`}catch{s+=`: ${l}`}}catch{}throw new Error(s)}if(r.status!==204)return r.json()}static prepareInput(i){const t={...i};for(const[e,n]of Object.entries(t))n&&typeof n=="object"&&!Array.isArray(n)&&"id"in n?(delete t[e],t[`${e}_id`]=n.id):Array.isArray(n)&&n.length>0&&typeof n[0]=="object"&&"id"in n[0]&&(delete t[e],t[`${e}_ids`]=n.map(a=>a.id));return t}static prepareRelations(i,t){const e=U[t];if(!e)return i;const n={...i};for(const[a,r]of Object.entries(n)){const s=e[a];s&&(s.type==="single_link"?(delete n[a],r&&typeof r=="object"&&"id"in r?n[`${a}_id`]=r.id:(typeof r=="string"||r===null)&&(n[`${a}_id`]=r)):s.type==="multi_link"&&(delete n[a],Array.isArray(r)?r.length>0&&typeof r[0]=="object"&&"id"in r[0]?n[`${a}_ids`]=r.map(l=>l.id):n[`${a}_ids`]=r:n[`${a}_ids`]=[]))}return n}};const C="onlyworlds_auth";class h extends Error{constructor(t,e){super(t),this.code=e,this.name="AuthError"}}class V{constructor(){this.state={isAuthenticated:!1,client:null,world:null,credentials:null},this.authChangeCallbacks=[]}async authenticate(t,e){if(!t||!e)throw new h("API key and pin are required","INVALID_CREDENTIALS");try{const n=new $({apiKey:t,apiPin:e}),a=await n.worlds.get();if(!a)throw new h("No world found. Create a world at onlyworlds.com first","NO_WORLD");return this.state={isAuthenticated:!0,client:n,world:a,credentials:{apiKey:t,apiPin:e}},this.saveCredentials(t,e),this.notifyAuthChange(),!0}catch(n){throw this.clearAuth(),n instanceof h?n:new h(`Authentication failed: ${n instanceof Error?n.message:"Unknown error"}`,"NETWORK_ERROR")}}async tryAutoAuth(){const t=this.loadCredentials();if(!t)return!1;try{return await this.authenticate(t.apiKey,t.apiPin),!0}catch(e){throw this.clearStorage(),e}}getClient(){if(!this.state.client||!this.state.isAuthenticated)throw new h("Not authenticated. Call authenticate() first","INVALID_CREDENTIALS");return this.state.client}getWorld(){if(!this.state.world||!this.state.isAuthenticated)throw new h("Not authenticated. Call authenticate() first","INVALID_CREDENTIALS");return this.state.world}getCredentials(){return this.state.credentials}isAuthenticated(){return this.state.isAuthenticated}onAuthChange(t){this.authChangeCallbacks.push(t)}notifyAuthChange(){const t=this.state.isAuthenticated;this.authChangeCallbacks.forEach(e=>{try{e(t)}catch(n){console.error("Error in auth change callback:",n)}})}logout(){this.clearAuth(),this.clearStorage(),this.notifyAuthChange()}clearAuth(){this.state={isAuthenticated:!1,client:null,world:null,credentials:null}}saveCredentials(t,e){try{localStorage.setItem(C,JSON.stringify({apiKey:t,apiPin:e,timestamp:Date.now()}))}catch(n){console.warn("Could not save credentials to localStorage:",n)}}loadCredentials(){try{const t=localStorage.getItem(C);if(!t)return null;const e=JSON.parse(t);return!e.apiKey||!e.apiPin?null:{apiKey:e.apiKey,apiPin:e.apiPin}}catch(t){return console.warn("Could not load credentials from localStorage:",t),null}}clearStorage(){try{localStorage.removeItem(C)}catch(t){console.warn("Could not clear credentials from localStorage:",t)}}}const y=new V;class F{constructor(t){this.client=null,this.authManager=t,t.isAuthenticated()&&(this.client=t.getClient()),this.authManager.onAuthChange(e=>{e?this.client=this.authManager.getClient():this.client=null})}getClient(){if(!this.client)throw new Error("Not authenticated. Please connect first.");return this.client}isReady(){return this.client!==null}getResource(t){const e=this.getClient(),n=`${t}s`;return e[n]}async listElements(t,e){return await this.getResource(t).list(e)}async getElement(t,e){return await this.getResource(t).get(e)}async createElement(t,e){return await this.getResource(t).create(e)}async updateElement(t,e,n){return await this.getResource(t).update(e,n)}async deleteElement(t,e){return await this.getResource(t).delete(e)}get characters(){return this.getClient().characters}get creatures(){return this.getClient().creatures}get species(){return this.getClient().species}get families(){return this.getClient().families}get collectives(){return this.getClient().collectives}get institutions(){return this.getClient().institutions}get locations(){return this.getClient().locations}get objects(){return this.getClient().objects}get constructs(){return this.getClient().constructs}get abilities(){return this.getClient().abilities}get traits(){return this.getClient().traits}get titles(){return this.getClient().titles}get languages(){return this.getClient().languages}get laws(){return this.getClient().laws}get events(){return this.getClient().events}get narratives(){return this.getClient().narratives}get phenomena(){return this.getClient().phenomena}get relations(){return this.getClient().relations}get maps(){return this.getClient().maps}get pins(){return this.getClient().pins}get markers(){return this.getClient().markers}get zones(){return this.getClient().zones}get worlds(){return this.getClient().worlds}}let w=null;function K(i){return w||(w=new F(i)),w}function Q(){if(!w)throw new Error("SDK Manager not initialized. Call initializeSDKManager first.");return w}class Z{constructor(){this.container=null,this.toasts=[],this.maxToasts=3}init(){this.container=document.getElementById("toast-container"),this.container||console.warn("Toast container not found")}show(t,e="info",n=4e3){if(!this.container){console.error("Toast manager not initialized");return}const a={id:`toast-${Date.now()}-${Math.random()}`,message:t,type:e,duration:n};if(this.toasts.push(a),this.toasts.length>this.maxToasts){const r=this.toasts.shift();r&&this.removeToast(r.id)}this.renderToast(a)}success(t,e){this.show(t,"success",e)}error(t,e){this.show(t,"error",e)}info(t,e){this.show(t,"info",e)}renderToast(t){if(!this.container)return;const e=document.createElement("div");e.id=t.id,e.className=`ow-toast ow-toast-${t.type}`;const n=this.getIcon(t.type);e.innerHTML=`
      <span class="material-icons ow-toast-icon">${n}</span>
      <span class="ow-toast-message">${this.escapeHtml(t.message)}</span>
    `,this.container.appendChild(e),setTimeout(()=>{this.removeToast(t.id)},t.duration)}removeToast(t){const e=document.getElementById(t);e&&(e.style.opacity="0",e.style.transform="translateY(100%)",setTimeout(()=>{e.remove()},300)),this.toasts=this.toasts.filter(n=>n.id!==t)}getIcon(t){switch(t){case"success":return"check_circle";case"error":return"error";case"info":return"info";default:return"info"}}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}clearAll(){this.toasts.forEach(t=>this.removeToast(t.id)),this.toasts=[]}}const k=new Z;window.showToast=(i,t="info")=>{k.show(i,t)};const tt=["character","creature","species","location","object","institution","collective","event","phenomenon","ability","trait","title","narrative","family","construct","language","law","relation"],et={location:3,character:2,creature:2,institution:2,event:1,phenomenon:1,species:1,collective:1,object:1};let E=[],b=[],T=[],m=null,q="map";const j=2400,I=1600;let f=0,_=0,v=1,A=!1,R=0,N=0,H=0,D=0;function W(i){const t=y.getWorld();i.innerHTML=`
    <div class="bg-app">
      <header class="bg-header">
        <div>
          <h1>the buried giant</h1>
          <span class="bg-header-sub">${t.name}</span>
        </div>
        <div class="bg-header-right">
          <button class="bg-view-toggle" id="view-toggle">
            <span class="material-icons" style="font-size:16px; color: inherit;">list</span>
            <span id="view-label">list</span>
          </button>
          <button class="bg-logout" id="logout-btn">leave</button>
        </div>
      </header>

      <div class="bg-body">
        <aside class="bg-sidebar" id="sidebar">
          <div class="bg-sidebar-title">chronicles</div>
          <div id="type-list"></div>
        </aside>

        <main class="bg-main" id="main-content">
          <div class="bg-loading">
            <div class="bg-loading-spinner"></div>
            gathering memories from the mist...
          </div>
        </main>
      </div>

      <div class="bg-mist"></div>
    </div>
  `,document.getElementById("logout-btn").addEventListener("click",()=>{y.logout(),k.info("logged out"),window.location.reload()}),document.getElementById("view-toggle").addEventListener("click",()=>{q=q==="map"?"list":"map";const e=document.getElementById("view-label"),n=document.querySelector("#view-toggle .material-icons");q==="map"?(e.textContent="list",n.textContent="list"):(e.textContent="map",n.textContent="map"),z()}),it()}async function it(){const i=Q(),t=[],e=tt.map(async s=>{try{const l=i[s+"s"];if(!l)return null;const o=await l.list(),u=nt(o);return u.length===0?null:{type:s,label:s,elements:u.map(p=>({...p,type:s}))}}catch(l){return console.warn(`Could not fetch ${s}s:`,l),null}});(await Promise.all(e)).forEach(s=>{s&&t.push(s)}),t.sort((s,l)=>l.elements.length-s.elements.length),E=t,b=t.flatMap(s=>s.elements),T=rt(b);const a=document.getElementById("main-content");a&&(f=-(j/2-a.clientWidth/2),_=-(I/2-a.clientHeight/2));const r=b.length;k.success(`${r} elements found across ${t.length} types`),Y(),z()}function nt(i){if(Array.isArray(i))return i;if(i?.results&&Array.isArray(i.results))return i.results;if(i&&typeof i=="object"){const t=Object.values(i);if(t.length>0&&Array.isArray(t[0]))return t[0]}return[]}function B(i){let t=5381;for(let e=0;e<i.length;e++)t=(t<<5)+t+i.charCodeAt(e)&4294967295;return Math.abs(t)}function rt(i){const e=j-160,n=I-80*2,a=[],r=i.filter(o=>o.type==="location"),s=i.filter(o=>o.type!=="location"),l=137.508*(Math.PI/180);return r.forEach((o,u)=>{const p=u*l,d=.2+u/Math.max(r.length,1)*.3,x=80+e/2+Math.cos(p)*d*e/2,g=80+n/2+Math.sin(p)*d*n/2;a.push({...o,x,y:g})}),s.forEach(o=>{const u=B(o.id+o.name),p=B(o.name+o.type);let d=80+u%e,x=80+p%n;for(let g=0;g<5;g++){let L=!1;for(const M of a){const P=M.x-d,O=M.y-x;if(Math.sqrt(P*P+O*O)<60){L=!0;break}}if(!L)break;d=80+(u+g*197)%e,x=80+(p+g*131)%n}a.push({...o,x:d,y:x})}),a}function Y(){const i=document.getElementById("type-list"),t=b.length;let e=`
    <button class="bg-type-btn ${m===null?"active":""}" data-type="all">
      <span>all elements</span>
      <span class="bg-type-count">${t}</span>
    </button>
  `;E.forEach(n=>{e+=`
      <button class="bg-type-btn ${m===n.type?"active":""}" data-type="${n.type}">
        <span>${n.label}s</span>
        <span class="bg-type-count">${n.elements.length}</span>
      </button>
    `}),i.innerHTML=e,i.querySelectorAll(".bg-type-btn").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.type;m=a==="all"?null:a,Y(),z()})})}function z(){q==="map"?at():st()}function at(){const i=document.getElementById("main-content"),t=m?T.filter(r=>r.type===m):T;if(t.length===0){i.innerHTML='<div class="bg-empty">no memories remain in this world...</div>';return}let e="";t.forEach(r=>{const s=et[r.type]||0,l=s>=3?"bg-marker-lg":s>=2?"bg-marker-md":"bg-marker-sm";e+=`
      <div class="bg-marker ${l} bg-marker-${r.type}"
           data-id="${r.id}" data-type="${r.type}"
           style="left: ${r.x}px; top: ${r.y}px;">
        <div class="bg-marker-dot"></div>
        <div class="bg-marker-label">${r.name}</div>
      </div>
    `}),i.innerHTML=`
    <div class="bg-map-container" id="map-container">
      <div class="bg-map-surface" id="map-surface" style="width:${j}px; height:${I}px; transform: translate(${f}px, ${_}px) scale(${v});">
        <div class="bg-map-decoration">
          <div class="bg-compass"></div>
        </div>
        ${e}
      </div>
    </div>
  `;const n=document.getElementById("map-container"),a=document.getElementById("map-surface");n.addEventListener("mousedown",r=>{r.target.closest(".bg-marker")||(A=!0,R=r.clientX,N=r.clientY,H=f,D=_,n.style.cursor="grabbing")}),window.addEventListener("mousemove",r=>{A&&(f=H+(r.clientX-R),_=D+(r.clientY-N),a.style.transform=`translate(${f}px, ${_}px) scale(${v})`)}),window.addEventListener("mouseup",()=>{A=!1,n.style.cursor="grab"}),n.addEventListener("wheel",r=>{r.preventDefault();const s=r.deltaY>0?-.1:.1;v=Math.min(2.5,Math.max(.3,v+s)),a.style.transform=`translate(${f}px, ${_}px) scale(${v})`},{passive:!1}),i.querySelectorAll(".bg-marker").forEach(r=>{r.addEventListener("click",s=>{s.stopPropagation();const l=r.dataset.id,o=b.find(u=>u.id===l);o&&G(o)})})}function st(){const i=document.getElementById("main-content"),t=m?E.filter(n=>n.type===m):E;if(t.length===0){i.innerHTML='<div class="bg-empty">nothing here but mist...</div>';return}let e="";t.forEach(n=>{e+=`<div class="bg-main-header">${n.label}s</div>`,e+='<div class="bg-element-grid">',n.elements.forEach(a=>{const r=a.description?a.description.substring(0,150)+(a.description.length>150?"...":""):"<em>lost to the mist</em>";e+=`
        <div class="bg-card" data-id="${a.id}" data-type="${a.type}">
          <div class="bg-card-name">${a.name}</div>
          <div class="bg-card-type">${a.type}</div>
          <div class="bg-card-desc">${r}</div>
        </div>
      `}),e+="</div>",e+='<div style="height: 32px;"></div>'}),i.innerHTML=e,i.querySelectorAll(".bg-card").forEach(n=>{n.addEventListener("click",()=>{const a=n.dataset.id,r=b.find(s=>s.id===a);r&&G(r)})})}function G(i){document.querySelector(".bg-detail-overlay")?.remove();const t=document.createElement("div");t.className="bg-detail-overlay";const e=new Set(["id","name","description","type","world","created_at","updated_at"]);let n="";Object.entries(i).forEach(([r,s])=>{if(e.has(r)||s==null||s===""||Array.isArray(s)&&s.length===0||typeof s=="object"&&!Array.isArray(s))return;const l=r.replace(/_/g," ");let o;Array.isArray(s)?o=s.map(u=>typeof u=="object"?u.name||JSON.stringify(u):u).join(", "):o=String(s),n+=`
      <div class="bg-detail-field">
        <div class="bg-detail-label">${l}</div>
        <div class="bg-detail-value">${o}</div>
      </div>
    `}),t.innerHTML=`
    <div class="bg-detail">
      <button class="bg-detail-close">&times;</button>
      <div class="bg-detail-type">${i.type}</div>
      <h2>${i.name}</h2>
      <div class="bg-detail-body">
        ${i.description?`<p style="margin-bottom: 20px;">${i.description}</p>`:""}
        ${n}
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelector(".bg-detail-close").addEventListener("click",()=>t.remove()),t.addEventListener("click",r=>{r.target===t&&t.remove()});const a=r=>{r.key==="Escape"&&(t.remove(),document.removeEventListener("keydown",a))};document.addEventListener("keydown",a)}const S=document.getElementById("app");k.init();async function lt(){try{if(await y.tryAutoAuth()){K(y),k.success(`connected to ${y.getWorld().name}`),W(S);return}}catch{}ot()}function ot(){S.innerHTML=`
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
      <div style="width: 100%; max-width: 400px; padding: var(--ow-space-4);">
        <h2 style="text-align: center; margin-bottom: var(--ow-space-1); text-transform: lowercase;">onlyworlds</h2>
        <p style="text-align: center; color: var(--ow-cyan-primary); margin-bottom: var(--ow-space-4); font-size: var(--ow-text-sm);">connect your world</p>

        <div style="display: flex; flex-direction: column; gap: var(--ow-space-2);">
          <input id="api-key" type="text" placeholder="api key" />
          <input id="api-pin" type="password" placeholder="pin" value="1111" />
          <button id="connect-btn" class="btn-primary" style="width: 100%; margin-top: var(--ow-space-1);">connect</button>
        </div>

        <p id="auth-error" style="color: var(--ow-error); text-align: center; margin-top: var(--ow-space-2); font-size: var(--ow-text-sm); display: none;"></p>
      </div>
    </div>
  `;const i=document.getElementById("connect-btn"),t=document.getElementById("api-key"),e=document.getElementById("api-pin"),n=document.getElementById("auth-error");i.addEventListener("click",async()=>{const a=t.value.trim(),r=e.value.trim();if(!a||!r){n.textContent="api key and pin required",n.style.display="block";return}i.textContent="connecting...",i.disabled=!0,n.style.display="none";try{await y.authenticate(a,r),K(y),k.success(`connected to ${y.getWorld().name}`),W(S)}catch(s){n.textContent=s instanceof Error?s.message:"connection failed",n.style.display="block",i.textContent="connect",i.disabled=!1}}),[t,e].forEach(a=>{a.addEventListener("keydown",r=>{r.key==="Enter"&&i.click()})})}lt();
